<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>希望旅程</title>
  <style>
    :root{
      --bg:#0f172a;       /* slate-900 */
      --panel:#111827ee;   /* gray-900/93 */
      --card:#0b1222;      /* dark card */
      --muted:#9ca3af;     /* gray-400 */
      --acc:#22c55e;       /* green-500 */
      --acc-2:#38bdf8;     /* sky-400 */
      --warn:#f59e0b;      /* amber-500 */
      --danger:#ef4444;    /* red-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, #1e293b 0%, #0b1020 45%, var(--bg) 100%);
      color:#e5e7eb; overflow:hidden;
    }
    .app{display:grid; grid-template-columns: 320px 1fr 360px; gap:16px; height:100%; padding:16px}
    @media (max-width: 1100px){.app{grid-template-columns:1fr; grid-template-rows:auto auto 1fr; overflow:auto}}
    .panel{background:linear-gradient(180deg, #0c1428 0%, #0a0f1d 100%); border:1px solid #1f2a44; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);height: 100%;display: flex;flex-direction: column;}
    h1{margin:0 0 6px; font-size:22px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px}
    .row{display:flex; gap:8px; align-items:center}
    .stack{display:flex; flex-direction:column; gap:8px}
    .kpi{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
    .kpi .card{background:var(--card); border:1px solid #1e293b; border-radius:12px; padding:10px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .val{font-weight:700; font-size:20px}
    .money{font-size:28px; font-weight:800}
    .pill{padding:4px 8px; background:#0f172a; border:1px solid #1f2a44; border-radius:999px; font-size:12px; color:var(--muted)}
    .btn{cursor:pointer; background:linear-gradient(180deg, #12325a 0%, #0d2545 100%); border:1px solid #1e3a5f; border-radius:12px; padding:10px 12px; color:#e5e7eb; font-weight:600}
    .btn:hover{filter:brightness(1.1)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn-acc{background:linear-gradient(180deg, #1f9e54 0%, #157d3f 100%); border-color:#1a7a45}
    .btn-warn{background:linear-gradient(180deg, #b97709 0%, #946107 100%); border-color:#9a6b09}
    .btn-ghost{background:#0a1222; border-color:#1f2a44}

    .progress{height:8px; background:#0b1222; border-radius:999px; overflow:hidden; border:1px solid #1f2a44}
    .bar{height:100%; background:linear-gradient(90deg, var(--acc), var(--acc-2)); width:0%}

    .cards{display:flex; flex-direction:column; gap:12px; overflow:auto; padding-right:4px;flex-grow: 1;}
    .card{background:linear-gradient(180deg, #0f1a32 0%, #0b1222 100%); border:1px solid #1f2a44; border-radius:16px; padding:14px}
    .card h3{margin:0 0 6px}
    .muted{color:var(--muted)}
    .right .project{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #1f2a44; color:#cbd5e1; background:#0b1222}
    .statrow{display:grid; grid-template-columns:1fr 1fr; gap:6px}
    .meter{height:8px; background:#0b1222; border:1px solid #1f2a44; border-radius:8px; overflow:hidden}
    .meter > span{display:block; height:100%; background:linear-gradient(90deg, #60a5fa, #34d399); width:50%}

    .sticky-footer{position:sticky; bottom:0; background:linear-gradient(180deg, #0b1222cc, #0b1222); border-top:1px solid #1f2a44; margin-top:8px; padding:12px; border-radius:14px}
    .foot-grid{display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center}

    .mini{font-size:12px}
    
    #fixed-footer {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 1000;
      background: linear-gradient(180deg, #0b1222cc, #0b1222);
      border: 1px solid #1f2a44;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
      transition: all 0.5s ease-in-out;
      width: auto;
      transform-origin: bottom right;
    }
    #fixed-footer.shrink {
      width: auto;
      padding: 10px 14px;
      transform: scale(0.8);
      cursor: pointer;
    }
    #fixed-footer.shrink > .foot-grid > div {
      display: none;
    }
    #fixed-footer.shrink .btn {
      width: 48px;
      height: 48px;
      padding: 0;
      font-size: 0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #fixed-footer.shrink .btn:first-child { display: none; }
    #fixed-footer.shrink .btn:last-child { margin-left: -8px; }
    #fixed-footer.shrink .btn-acc::before {
      content: "✅";
      font-size: 24px;
    }

    /* 新增的社群信任樣式 */
    .trust-gauge {
      position: relative;
      height: 20px;
      background: #444; /* 黑暗底色 */
      border-radius: 10px;
      overflow: hidden;
      margin-top: 4px;
    }
    .trust-bar {
      height: 100%;
      width: var(--trust-val);
      background: linear-gradient(90deg, #a1a1aa, #34d399); /* 灰色到綠色漸層 */
      transition: background-color 0.5s ease;
      position: relative;
    }
    .trust-pointer {
      position: absolute;
      left: 50%;
      height: 100%;
      width: 2px;
      background: #e5e7eb;
      transform: translateX(-50%);
      z-index: 1;
    }
    .trust-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .trust-label.left { left: 10%; }
    .trust-label.right { left: 90%; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel stack">
      <div>
        <h1>🏡 希望旅程</h1>
        <div class="sub">塞內加爾球星 Sadio Mané 的人生故事，見證 ~在球場外，為家鄉創造希望的力量，你也可以做到。</div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="label">可用資金</div>
          <div class="money" id="money">$0</div>
        </div>
        <div class="card">
          <div class="label">月份／年</div>
          <div class="val"><span id="month">1</span> / <span id="year">1</span>年</div>
        </div>
        <div class="card">
          <div class="label">月收入（職涯）</div>
          <div class="val" id="income">$0</div>
        </div>
        <div class="card">
          <div class="label">社群信任</div>
          <div class="trust-gauge">
            <div class="trust-pointer"></div>
            <div class="trust-bar" id="trustBar"></div>
          </div>
          <div class="sub" style="text-align:center; margin-top:4px;display:flex; justify-content: space-between;">
            <span>黑暗</span><span>平淡</span><span>光明</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="label">再前進一點</div>
            <div class="progress" aria-label="影響力進度">
              <div class="bar" id="impactBar"></div>
            </div>
          </div>
          <div class="pill" id="impactScore">0 分</div>
        </div>
      </div>

      <div class="card">
        <div class="label">所見的需要</div>
        <div class="statrow">
          <div>
            教育
            <div class="meter"><span id="eduMeter" style="width:20%"></span></div>
          </div>
          <div>
            醫療
            <div class="meter"><span id="healthMeter" style="width:20%"></span></div>
          </div>
          <div>
            用水
            <div class="meter"><span id="waterMeter" style="width:20%"></span></div>
          </div>
          <div>
            就業
            <div class="meter"><span id="jobsMeter" style="width:20%"></span></div>
          </div>
          <div>
            體育
            <div class="meter"><span id="sportsMeter" style="width:20%"></span></div>
          </div>
          <div>
            運行
            <div class="meter"><span id="maintMeter" style="width:50%"></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="btn btn-ghost" id="saveBtn">💾 主動休息</button>
        <button class="btn btn-ghost" id="loadBtn">📂 載入</button>
        <button class="btn btn-warn" id="resetBtn">🗑️ 遊戲可重來</button>
      </div>
    </aside>

    <main class="panel">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h1>📜 本月事件</h1>
          <div class="sub">根據事件做抉擇，你的決定影響著所看見的需要與財務。</div>
        </div>
        <div class="pill" id="villageTag">🏘️ 家鄉：未命名</div>
      </div>

      <div class="cards" id="eventList" aria-live="polite"></div>
    </main>

    <aside class="panel right stack">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h1>🧭 專案選單</h1>
          <div class="sub">選擇想行動的在地專案（可重複建置在不同地方）。</div>
        </div>
        <button class="btn" id="renameBtn">✏️ 設定家鄉名稱</button>
      </div>

      <div class="cards" id="projectList"></div>
    </aside>
  </div>

  <div id="fixed-footer" class="active">
    <div class="foot-grid">
      <div class="mini muted">
        提示：每個月會自動結算運行成本與帶來的長期收益。社群信任會影響募資與志工參與。
      </div>
      <button class="btn" id="skipBtn">➡️ 禱告</button>
      <button class="btn btn-acc" id="nextBtn">✅ 行動</button>
    </div>
  </div>

  <script>
    // 遊戲核心狀態
    const Game = {
      month: 1,
      year: 1,
      money: 1, // 初始資金
      baseIncome: 10000, // 每月職涯收入（可想像為合約與代言）
      trust: 50, // 0-100
      metrics: { edu:20, health:20, water:20, jobs:20, sports:20, maint:50 }, // 0-100
      villageName: "未命名",
      projects: [], // 建置中的專案
      history: [], // 事件紀錄
    };

    // 專案藍圖（可自由擴充）
    const PROJECT_CATALOG = [
      {
        id:"school", name:"📚 小學翻修", cost: 90000, monthlyUpkeep: 4000,
        effects:{ edu:+8, jobs:+1, maint:-1 }, longTerm:"提升入學率與師資意願"
      },
      {
        id:"clinic", name:"🏥 基礎診療站", cost: 120000, monthlyUpkeep: 6000,
        effects:{ health:+10, jobs:+1, maint:-2 }, longTerm:"降低可避免的疾病風險"
      },
      {
        id:"well", name:"🚰 深水井與淨水", cost: 70000, monthlyUpkeep: 2000,
        effects:{ water:+12, health:+2, maint:-1 }, longTerm:"改善用水，減少取水時間"
      },
      {
        id:"academy", name:"⚽ 少年足球訓練中心", cost: 60000, monthlyUpkeep: 3000,
        effects:{ sports:+10, edu:+2, jobs:+1, maint:-1 }, longTerm:"以運動帶動向上與凝聚"
      },
      {
        id:"micro", name:"💼 微型創業基金", cost: 50000, monthlyUpkeep: 2000,
        effects:{ jobs:+8, trust:+3 }, longTerm:"支持小店與家庭生計"
      },
      {
        id:"solar", name:"🔆 太陽能路燈", cost: 40000, monthlyUpkeep: 1000,
        effects:{ trust:+2, jobs:+1, maint:+1 }, longTerm:"提高夜間安全與活動"
      },
      {
        id:"communityMeal", name:"🍲 社區免費餐會", cost: 20000, monthlyUpkeep: 3000,
        effects:{ trust:+8, maint:+2 }, longTerm:"提供弱勢餐食，增進社群關係"
      },
      {
        id:"youthClub", name:"🏀 青少年週末活動", cost: 30000, monthlyUpkeep: 2000,
        effects:{ edu:+5, sports:+4, trust:+4 }, longTerm:"帶領青少年正向活動，建立信任"
      },
      {
        id:"elderVisit", name:"👵 長者關懷探訪", cost: 2000, monthlyUpkeep: 1000,
        effects:{ trust:+6, maint:+1 }, longTerm:"探訪長者，傳遞關懷與陪伴"
      },
      {
        id:"afterSchool", name:"📚 放學輔導班", cost: 4000, monthlyUpkeep: 2500,
        effects:{ edu:+8, trust:+3 }, longTerm:"輔導弱勢學生，提升學習與信任"
      },
      {
        id:"healthCheck", name:"🩺 社區健康檢查", cost: 50000, monthlyUpkeep: 3000,
        effects:{ health:+8, trust:+4 }, longTerm:"提供基本健康檢查，增強社群健康意識"
      },
      {
        id:"musicMinistry", name:"🎵 社區音樂服事", cost: 3000, monthlyUpkeep: 1000,
        effects:{ trust:+3, edu:+2 }, longTerm:"透過音樂帶來祝福與社群凝聚"
      },
      {
        id:"workshopSkills", name:"🛠️ 社區技能工作坊", cost: 35000, monthlyUpkeep: 3000,
        effects:{ jobs:+5, edu:+4, trust:+3 }, longTerm:"教導生活與工作技能，提升自立能力"
      },
      {
        id:"cleanUpDay", name:"🧹 社區清潔日", cost: 5000, monthlyUpkeep: 1000,
        effects:{ maint:+5, trust:+2 }, longTerm:"組織社區清潔活動，改善居住環境"
      },
      {
        id:"charityDrive", name:"🎁 社區物資捐贈", cost: 6000, monthlyUpkeep: 1000,
        effects:{ trust:+6, maint:+1 }, longTerm:"收集與分發物資給有需要的人"
      },
      {
        id:"storyTime", name:"📖 社區親子說故事", cost: 8000, monthlyUpkeep: 700,
        effects:{ edu:+3, trust:+3 }, longTerm:"透過親子故事活動建立良好社區互動"
      },
      {
        id:"streetArt", name:"🎨 街頭藝術計畫", cost: 40000, monthlyUpkeep: 2000,
        effects:{ trust:+5, edu:+2 }, longTerm:"美化社區環境，吸引觀光與創意人才"
      },
      {
        id:"recycleHub", name:"♻️ 社區資源回收中心", cost: 50000, monthlyUpkeep: 1000,
        effects:{ maint:+3, trust:+2 }, longTerm:"提升環保意識，減少浪費"
      },
      {
        id:"techLab", name:"💻 創客實驗室", cost: 90000, monthlyUpkeep: 2500,
        effects:{ edu:+8, jobs:+5, trust:+3 }, longTerm:"培養科技技能與創業能力"
      },
      {
        id:"elderCare", name:"👵 長者關懷中心", cost: 80000, monthlyUpkeep: 1500,
        effects:{ trust:+6, maint:+1 }, longTerm:"提升社區關懷與老人福祉"
      },
      {
        id:"urbanGarden", name:"🌿 都市共享花園", cost: 30000, monthlyUpkeep: 1000,
        effects:{ edu:+2, trust:+3, maint:+2 }, longTerm:"改善城市綠化與社群互動"
      },
      {
        id:"culturalFest", name:"🎭 社區文化節", cost: 60000, monthlyUpkeep: 2000,
        effects:{ trust:+8, edu:+2 }, longTerm:"促進文化交流與社群凝聚"
      },
      {
        id:"bikeLane", name:"🚴 安全自行車道", cost: 70000, monthlyUpkeep: 3000,
        effects:{ maint:+4, trust:+3 }, longTerm:"鼓勵低碳運輸與健康生活"
      },
      {
        id:"emergencyKit", name:"🧰 災害應變物資庫", cost: 50000, monthlyUpkeep: 10000,
        effects:{ maint:+5, trust:+2 }, longTerm:"提升社區韌性與緊急應變能力"
      },
      {
        id:"startupFund", name:"🚀 青年創業基金", cost: 100000, monthlyUpkeep: 1000,
        effects:{ jobs:+10, trust:+4 }, longTerm:"支持年輕創業者，刺激經濟活力"
      },
      {
        id:"solarFarm", name:"☀️ 小型太陽能農場", cost: 120000, monthlyUpkeep: 3000,
        effects:{ trust:+3, maint:+2, jobs:+2 }, longTerm:"生產再生能源，改善環境與就業"
      }
    ];

    // 隨機事件池
    const EVENTS = [
      {
        id:"press",
        text:"媒體關注你的家鄉計畫，若接受專訪可提升信任，但你需實際投入到在地活動。",
        choices:[
          {label:"接受：並實際投入，過程花費$10,000，信任+8", apply:s=>{s.money-=10000; s.trust=Math.min(100,s.trust+8)}},
          {label:"婉拒：無花費，信任-3", apply:s=>{s.trust=Math.max(0,s.trust-3)}}
        ]
      },
      {
        id:"flood",
        text:"暴雨造成道路受損，若立即修補可避免運行惡化。",
        choices:[
          {label:"緊急修補：花$50,000，運行+6", apply:s=>{s.money-=50000; s.metrics.maint=Math.min(100,s.metrics.maint+6)}},
          {label:"暫緩：省錢但運行-6", apply:s=>{s.metrics.maint=Math.max(0,s.metrics.maint-6)}}
        ]
      },
      {
        id:"sponsor",
        text:"品牌邀請公益聯名，若參與可增加月收入但需每月投入志工時數（降低運行壓力）。",
        choices:[
          {label:"參與：月收入+$10,000，運行+2", apply:s=>{s.baseIncome+=10000; s.metrics.maint=Math.min(100,s.metrics.maint+2)}},
          {label:"不參與：保持現狀", apply:s=>{}}
        ]
      },
      {
        id:"match",
        text:"本月賽事表現出色，獲得比賽獎金$30,000，是否全數捐入基金？",
        choices:[
          {label:"全數投入公益（+信任5）", apply:s=>{s.trust=Math.min(100,s.trust+5)}},
          {label:"保留一半（+現金15,000，+信任1）", apply:s=>{s.money+=15000; s.trust=Math.min(100,s.trust+1)}},
          {label:"自行運用（+現金30,000）", apply:s=>{s.money+=30000}}
        ]
      },
    {
        id:"scandal",
        text:"有人謠傳你挪用公益款項去買跑車，若不處理將嚴重影響你的聲譽。",
        choices:[
          {label:"公開財務明細：花$30,000公關費澄清，信任+10", apply:s=>{s.money-=30000; s.trust=Math.min(100,s.trust+10)}},
          {label:"冷處理：不回應謠言，信任-20", apply:s=>{s.trust=Math.max(0,s.trust-20)}}
        ]
      },
      {
        id:"fundraiser",
        text:"當地企業看見了你的努力，願意舉辦一場聯合慈善募款，但需投入人力協辦。",
        choices:[
          {label:"全力協辦：花費$10,000人力成本，隨機獲得$6~$30,000募款", apply:s=>{s.money-=10000; s.money+=Math.floor(Math.random()*(30000-6+1))+6;;}},
          {label:"婉拒：專注當下專案，無收益也無花費", apply:s=>{}}
        ]
      },
      {
        id:"volunteer",
        text:"社群自發性組織志工團體，願意為你的專案提供無償勞力，但需要你提供物資支持。",
        choices:[
          {label:"提供物資：花$3,000，隨機提升任一指標+5", apply:s=>{const metrics = ['edu', 'health', 'water', 'jobs', 'sports', 'maint']; const randomMetric = metrics[Math.floor(Math.random()*metrics.length)]; s.money-=3000; s.metrics[randomMetric]=Math.min(100, s.metrics[randomMetric]+5);}},
          {label:"無力支持：感謝他們的好意，但無力支持，信任-5", apply:s=>{s.trust=Math.max(0, s.trust-5);}}
        ]
      },
      {
        id:"policy",
        text:"政府考慮推動一項新政策，將影響你部分專案的合法性。",
        choices:[
          {label:"發揮影響力：籌辦講座，過程花費$50,000，提升信任+5，並避免運行-8", apply:s=>{s.money-=50000; s.trust=Math.min(100,s.trust+5);}},
          {label:"不介入：省下費用，但運行-8", apply:s=>{s.metrics.maint=Math.max(0, s.metrics.maint-8);}}
        ]
      },
      {
        id:"media",
        text:"當地媒體想拍攝一部關於你的紀錄片，這能讓你的計畫廣為人知，但需要花時間配合。",
        choices:[
          {label:"同意拍攝：信任+8，接下來月收入額外增加$200", apply:s=>{s.trust=Math.min(100,s.trust+8); s.baseIncome+=200;}},
          {label:"拒絕：無變化", apply:s=>{}}
        ]
      },
{
  id: "waterCrisis",
  text: "社區的主要水井出現污染嫌疑，居民開始抱怨飲用水品質。",
  choices: [
    {
      label: "投資淨水系統：花費$8,000，水指標+10，運行+3",
      apply: s => {
        s.money -= 8000;
        s.metrics.water = clamp(s.metrics.water + 10, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 3, 0, 100);
      }
    },
    {
      label: "推廣節水教育：花費$1,500，水指標+4，信任+3",
      apply: s => {
        s.money -= 1500;
        s.metrics.water = clamp(s.metrics.water + 4, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "不作為：無花費，水指標-6，信任-5",
      apply: s => {
        s.metrics.water = Math.max(0, s.metrics.water - 6);
        s.trust = Math.max(0, s.trust - 5);
      }
    }
  ]
},

// 2. 學校升級提案
{
  id: "schoolUpgrade",
  text: "當地小學請求協助翻新教室，孩子們期待更好的學習環境。",
  choices: [
    {
      label: "全額贊助：花費$10,000，教育+12，信任+5",
      apply: s => {
        s.money -= 10000;
        s.metrics.edu = clamp(s.metrics.edu + 12, 0, 100);
        s.trust = clamp(s.trust + 5, 0, 100);
      }
    },
    {
      label: "尋求企業贊助：花費$2,000，就業+3，教育+6，運行+2",
      apply: s => {
        s.money -= 2000;
        s.metrics.jobs = clamp(s.metrics.jobs + 3, 0, 100);
        s.metrics.edu = clamp(s.metrics.edu + 6, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "將提案擱置：信任-4，教育-3",
      apply: s => {
        s.trust = Math.max(0, s.trust - 4);
        s.metrics.edu = Math.max(0, s.metrics.edu - 3);
      }
    }
  ]
},

// 3. 地區運動會
{
  id: "sportsFestival",
  text: "隔壁村想舉辦地區運動會，邀請你的社區參與並承辦部分賽事。",
  choices: [
    {
      label: "承辦開幕儀式：花費$7,000，體育+10，信任+4，運行+5",
      apply: s => {
        s.money -= 7000;
        s.metrics.sports = clamp(s.metrics.sports + 10, 0, 100);
        s.trust = clamp(s.trust + 4, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 5, 0, 100);
      }
    },
    {
      label: "只派隊參加：花費$1,200，體育+5，信任+2",
      apply: s => {
        s.money -= 1200;
        s.metrics.sports = clamp(s.metrics.sports + 5, 0, 100);
        s.trust = clamp(s.trust + 2, 0, 100);
      }
    },
    {
      label: "婉拒邀請：信任-3",
      apply: s => {
        s.trust = Math.max(0, s.trust - 3);
      }
    }
  ]
},

// 4. 健康檢測行動
{
  id: "healthCheck",
  text: "公共衛生組織提供免費健康檢測，但需派員協助場地與後勤。",
  choices: [
    {
      label: "提供場地支援：花費$3,000，醫療+8，信任+3",
      apply: s => {
        s.money -= 3000;
        s.metrics.health = clamp(s.metrics.health + 8, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "只派志願者：醫療+4，信任+2",
      apply: s => {
        s.metrics.health = clamp(s.metrics.health + 4, 0, 100);
        s.trust = clamp(s.trust + 2, 0, 100);
      }
    },
    {
      label: "拒絕合作：醫療-5，信任-4",
      apply: s => {
        s.metrics.health = Math.max(0, s.metrics.health - 5);
        s.trust = Math.max(0, s.trust - 4);
      }
    }
  ]
},

// 5. 環保補助計畫
{
  id: "greenGrant",
  text: "國際基金會提供綠能補助，你可以申請太陽能板或節能街燈。",
  choices: [
    {
      label: "裝設太陽能板：花費$12,000，用水+5，運行+6，信任+5",
      apply: s => {
        s.money -= 12000;
        s.metrics.water = clamp(s.metrics.water + 5, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 6, 0, 100);
        s.trust = clamp(s.trust + 5, 0, 100);
      }
    },
    {
      label: "換成節能街燈：花費$6,000，運行+4，信任+3",
      apply: s => {
        s.money -= 6000;
        s.metrics.maint = clamp(s.metrics.maint + 4, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "放棄申請：信任-2",
      apply: s => {
        s.trust = Math.max(0, s.trust - 2);
      }
    }
  ]
},
// 1. 臨時停電
{
  id: "powerOutage",
  text: "社區突發短暫停電，居民抱怨家用電器可能受損。",
  choices: [
    {
      label: "提供臨時照明與小額補助：花費$800，醫療+3，信任+4",
      apply: s => {
        s.money -= 800;
        s.metrics.health = clamp(s.metrics.health + 3, 0, 100);
        s.trust = clamp(s.trust + 4, 0, 100);
      }
    },
    {
      label: "申請緊急維修隊：花費$1,200，運行+6，信任+2",
      apply: s => {
        s.money -= 1200;
        s.metrics.maint = clamp(s.metrics.maint + 6, 0, 100);
        s.trust = clamp(s.trust + 2, 0, 100);
      }
    },
    {
      label: "讓居民自理：信任-5",
      apply: s => {
        s.trust = Math.max(0, s.trust - 5);
      }
    }
  ]
},

// 2. 路面坑洞
{
  id: "roadPothole",
  text: "主要道路出現坑洞，行人和車輛都容易受損。",
  choices: [
    {
      label: "緊急修補：花費$1,500，運行+5，信任+4",
      apply: s => {
        s.money -= 1500;
        s.metrics.maint = clamp(s.metrics.maint + 5, 0, 100);
        s.trust = clamp(s.trust + 4, 0, 100);
      }
    },
    {
      label: "排程例行維修：花費$500，運行+2",
      apply: s => {
        s.money -= 500;
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "忽視不理：運行-4，信任-3",
      apply: s => {
        s.metrics.maint = Math.max(0, s.metrics.maint - 4);
        s.trust = Math.max(0, s.trust - 3);
      }
    }
  ]
},

// 3. 社區流浪犬
{
  id: "strayDog",
  text: "社區出現流浪犬，部分居民擔心安全與衛生問題。",
  choices: [
    {
      label: "成立臨時收容中心：花費$1,000，醫療+4，信任+5",
      apply: s => {
        s.money -= 1000;
        s.metrics.health = clamp(s.metrics.health + 4, 0, 100);
        s.trust = clamp(s.trust + 5, 0, 100);
      }
    },
    {
      label: "鼓勵居民認養：醫療+2，信任+3",
      apply: s => {
        s.metrics.health = clamp(s.metrics.health + 2, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "不理會：醫療-3，信任-4",
      apply: s => {
        s.metrics.health = Math.max(0, s.metrics.health - 3);
        s.trust = Math.max(0, s.trust - 4);
      }
    }
  ]
},

// 4. 鄰里噪音投訴
{
  id: "noiseComplaint",
  text: "夜晚聚會音量過大，附近居民投訴不斷上門。",
  choices: [
    {
      label: "協助協調降噪：花費$200，信任+4，運行+1",
      apply: s => {
        s.money -= 200;
        s.trust = clamp(s.trust + 4, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 1, 0, 100);
      }
    },
    {
      label: "發布社區安寧守則：花費$100，信任+2，運行+2",
      apply: s => {
        s.money -= 100;
        s.trust = clamp(s.trust + 2, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "不採取行動：信任-3",
      apply: s => {
        s.trust = Math.max(0, s.trust - 3);
      }
    }
  ]
},

// 5. 小型義賣市集
{
  id: "communityBazaar",
  text: "居民提議在廣場舉辦義賣市集，募集資金改善社區設施。",
  choices: [
    {
      label: "主辦義賣：花費$2,000，募款$3,000，信任+6，運行+2",
      apply: s => {
        s.money -= 2000;
        s.money = clamp(s.money + 3000, 0, Infinity);
        s.trust = clamp(s.trust + 6, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "僅資助攤位：花費$500，募款$800，信任+3",
      apply: s => {
        s.money -= 500;
        s.money = clamp(s.money + 800, 0, Infinity);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "錯過機會：信任-4",
      apply: s => {
        s.trust = Math.max(0, s.trust - 4);
      }
    }
  ]
}
    ];

    // 工具
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const fmt = n => "$"+ n.toLocaleString();

    // 狀態渲染
    function renderState(){
      $('#money').textContent = fmt(Game.money);
      $('#income').textContent = fmt(Game.baseIncome);
      $('#month').textContent = Game.month;
      $('#year').textContent = Game.year;
      
      // 社群信任長條圖
      const trustBar = $('#trustBar');
      let trustColor, trustBgColor;
      if (Game.trust >= 100) {
        trustColor = '#fcd34d'; // 淡黃色光芒
        trustBgColor = '#f59e0b';
      } else if (Game.trust > 50) {
        trustColor = '#34d399'; // 藍綠色
        trustBgColor = '#15803d';
      } else {
        trustColor = '#71717a'; // 灰色
        trustBgColor = '#3f3f46';
      }
      trustBar.style.width = Game.trust + '%';
      trustBar.style.background = `linear-gradient(90deg, ${trustBgColor}, ${trustColor})`;
      
      $('#villageTag').textContent = `🏘️ 家鄉：${Game.villageName}`;

      // 影響分數（簡化：各指標平均 + 信任加權）
      const m = Game.metrics; const avg = (m.edu+m.health+m.water+m.jobs+m.sports+m.maint)/6;
      const impact = Math.round(avg*0.7 + Game.trust*0.3);
      const bar = Math.max(0, Math.min(100, impact));
      $('#impactBar').style.width = bar + '%';
      $('#impactScore').textContent = impact + ' 分';

      // 指標條
      $('#eduMeter').style.width = m.edu+'%';
      $('#healthMeter').style.width = m.health+'%';
      $('#waterMeter').style.width = m.water+'%';
      $('#jobsMeter').style.width = m.jobs+'%';
      $('#sportsMeter').style.width = m.sports+'%';
      $('#maintMeter').style.width = m.maint+'%';
    }

    // 專案渲染
    function renderProjects(){
      const box = $('#projectList');
      box.innerHTML = ''; // 清空容器內容

      // 確保每次呼叫都重新隨機選取 6 個專案
      const shuffledCatalog = [...PROJECT_CATALOG].sort(() => 0.5 - Math.random());
      const projectsToShow = shuffledCatalog.slice(0, 6);

      // 遍歷這 6 個專案來渲染
      projectsToShow.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'card project';
        el.innerHTML = `
          <div>
            <h3>${p.name}</h3>
            <div class="muted mini">一次成本：${fmt(p.cost)}｜每月維護支出：${fmt(p.monthlyUpkeep)}<br>${p.longTerm}</div>
            <div class="row" style="gap:6px; flex-wrap:wrap; margin-top:8px">
              ${Object.entries(p.effects).map(([k,v])=>`<span class="tag">${labelOf(k)} ${v>0?'+':''}${v}</span>`).join('')}
            </div>
          </div>
          <div class="stack" style="align-items:end">
            <button class="btn btn-acc" ${Game.money<p.cost?'disabled':''}>投資</button>
            <span class="pill mini">${Game.money<p.cost?'資金不足':'可建置'}</span>
          </div>
        `;
        el.querySelector('button').onclick=()=>buildProject(p);
        box.appendChild(el);
      });

      // 已建置清單
      if(Game.projects.length){
        const list = document.createElement('div');
        list.className='card';
        list.innerHTML = `<h3>已建置與運行</h3>`;
        Game.projects.forEach((proj,i)=>{
          const row = document.createElement('div');
          row.className='row';
          row.style.justifyContent='space-between';
          row.style.marginTop='6px';
          row.innerHTML = `<div class="mini">${proj.name} <span class="muted">（第${proj.builtAt.year}年${proj.builtAt.month}月）</span></div>
                           <div class="pill mini">運行：${fmt(proj.monthlyUpkeep)}</div>`;
          list.appendChild(row);
        })
        box.appendChild(list);
      }
    }

    function labelOf(k){
      return ({edu:'教育',health:'醫療',water:'用水',jobs:'就業',sports:'體育',maint:'運行',trust:'信任'})[k]||k;
    }

    // 事件生成與渲染
    function drawEvents(){
      const box = $('#eventList');
      box.innerHTML = '';
      const pool = pick(EVENTS, 2 + (Math.random()>0.7?1:0));
      pool.forEach(e=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${emojiFor(e.id)}：${e.text}</h3>`;
        
        const choicesContainer = document.createElement('div');
        choicesContainer.className = 'choices-container'; // 可以添加CSS來佈局按鈕
        
        e.choices.forEach(c=>{
          const btn = document.createElement('button');
          btn.className='btn';
          btn.textContent=c.label;
          btn.onclick=()=>{
            c.apply(Game);
            renderState();
            disableCard(card);
          };
          choicesContainer.appendChild(btn);
          choicesContainer.appendChild(document.createTextNode(' '));
        });
        card.appendChild(choicesContainer);
        box.appendChild(card);
      });
    }
    
    function emojiFor(id){
      return ({press:'📰', flood:'🌧️', sponsor:'🤝', match:'🥇'})[id] || '📌';
    }
    
    function disableCard(card){
      [...card.querySelectorAll('button')].forEach(b=>{b.disabled=true; b.classList.add('btn-ghost')});
      const note = document.createElement('div'); note.className='muted mini'; note.textContent='已選擇'; card.appendChild(document.createElement('br')); card.appendChild(note);
    }

    function buildProject(p){
  if (Game.money < p.cost) return;
  // 一次性成本
  Game.money -= p.cost;
  // 永久減少每月職涯收入
  Game.baseIncome = Math.max(0, Game.baseIncome - p.monthlyUpkeep);
  // 記錄建置時間
  Game.projects.push({
    ...p,
    builtAt: { year: Game.year, month: Game.month }
  });
  // （可選）微幅增加信任
  const trustGain = p.effects.trust ? Math.max(1, p.effects.trust) : 1;
  Game.trust = Math.min(100, Game.trust + trustGain);
  renderState();
  renderProjects();
  toast(`已建置：${p.name}，每月職涯收入減少 ${fmt(p.monthlyUpkeep)}`);
}

// 月結算
function settleMonth(skipWarnings=false){
  // 計算本月淨收入
  const upkeep = Game.projects.reduce((a,p)=>a+p.monthlyUpkeep,0);
  const netIncome = Game.baseIncome - upkeep;
  // 收入
  Game.money += netIncome;
  // 更新收入顯示，讓它顯示淨收入
  $('#income').textContent = fmt(netIncome);
  // 長期效果疊加
  Game.projects.forEach(p=>{
    for(const [k,v] of Object.entries(p.effects)){
      if(k==='trust'){ Game.trust = clamp(Game.trust + v*0.2,0,100); }
      else { Game.metrics[k] = clamp(Game.metrics[k] + v*0.5, 0, 100); }
    }
  });
    // 維護值每月扣減，正常結算 → 扣運行 1
  Game.metrics.maint = Math.max(0, Game.metrics.maint - 1);
  // 運行不足懲罰
  if(Game.metrics.maint < 3){
    Game.trust = Math.max(0, Game.trust - 0.1);
    Game.metrics.edu = Math.max(0, Game.metrics.edu - 0.1);
    Game.metrics.health = Math.max(0, Game.metrics.health - 0.1);
  }
  // 現金不足警示
  if(Game.money < 0 && !skipWarnings){
    alert('注意：現金流為負！請增加收入或減少新建專案。');
  }
  // 時間遞進
  Game.month++; if(Game.month>12){ Game.month=1; Game.year++; }
  renderState(); renderProjects(); drawEvents();
  toast('已結算本月：收入與運行已體現在指標');
  saveAuto();
}
    function skipToSettle(){
      let roll = Math.floor(Math.random() * 100) + 1; // 1~100
      let finalIncome;

      if(roll <= 5){ // 5%機率
        Game.baseIncome += 9999;
        toast('✨ 感恩！你的職涯月收入永久增加 +$9,999 ✨');
        finalIncome = 0; // 當月不領錢
      } else { // 95%機率，隨機獲得一部分收入
        const percentage = Math.floor(Math.random() * 30) + 1; // 1%~30%
        finalIncome = Math.floor(Game.baseIncome * (percentage / 100));
        toast(`➡️ 你選擇禱告，本月收入為 ${fmt(finalIncome)} （隨機結果：${percentage}%）`);
      }

      Game.money += finalIncome;

      // 不扣運行、不算 upkeep，只推進時間
      Game.month++;
      if(Game.month > 12){
        Game.month = 1;
        Game.year++;
      }

      renderState();
      renderProjects();
      drawEvents();
      saveAuto();
    }

    // 儲存 / 載入
    function save(name='autosave'){
      localStorage.setItem('hometown_saver_'+name, JSON.stringify(Game));
      toast('已儲存進度');
    }
    function load(name='autosave'){
      const raw = localStorage.getItem('hometown_saver_'+name);
      if(!raw){ toast('找不到存檔'); return; }
      const data = JSON.parse(raw);
      Object.assign(Game, data);
      renderState(); renderProjects(); drawEvents();
      toast('載入成功');
    }
    const saveAuto = ()=> save('autosave');

    // 其他輔助
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function pick(arr, n){
      const pool = [...arr]; const out=[]; while(out.length<n && pool.length){
        const i = Math.floor(Math.random()*pool.length); out.push(pool.splice(i,1)[0]);
      } return out;
    }
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg; t.className='pill'; t.style.position='fixed'; t.style.right='18px'; t.style.bottom='18px'; t.style.zIndex=50; t.style.background='#0b1222ee'; t.style.border='1px solid #1f2a44';
      document.body.appendChild(t); setTimeout(()=>t.remove(), 2200);
    }

    // 事件綁定
    $('#saveBtn').onclick = ()=> save('slot1');
    $('#loadBtn').onclick = ()=> load('slot1');
    $('#resetBtn').onclick = ()=>{ if(confirm('確定要開新局嗎？目前進度將清除。')){ localStorage.removeItem('hometown_saver_slot1'); localStorage.removeItem('hometown_saver_autosave'); location.reload(); } };
    $('#renameBtn').onclick = ()=>{
      const name = prompt('請輸入你的家鄉名稱（例如：班巴利、清水村…）', Game.villageName);
      if(name){ Game.villageName = name.trim().slice(0,20); renderState(); saveAuto(); }
    };
    
    // 延遲縮小腳部提示
    const footer = $('#fixed-footer');
    let shrinkTimeout;

    function resetShrinkTimer() {
        clearTimeout(shrinkTimeout);
        footer.classList.remove('shrink');
        shrinkTimeout = setTimeout(() => {
            footer.classList.add('shrink');
        }, 5000); // 5秒後自動縮小
    }
    
    // 點擊「行動」或「禱告」時，執行對應函數並重置計時器
    $('#nextBtn').onclick = () => {
      settleMonth();
      resetShrinkTimer();
    };
    
    $('#skipBtn').onclick = () => {
      skipToSettle();
      resetShrinkTimer();
    };

    // 點擊縮小後的按鈕，展開提示
    footer.onclick = () => {
        if (footer.classList.contains('shrink')) {
            resetShrinkTimer();
        }
    };

    // 初始化
    (function init(){
      renderState(); renderProjects(); drawEvents();
      resetShrinkTimer();
      // 初始提示
      setTimeout(()=>toast('提示：禱告很重要，你要安靜你的心，凡事感恩會使你增強心理健康，如提升幸福感、減輕焦慮與抑鬱'), 600);
    })();
  </script>
</body>
</html>
