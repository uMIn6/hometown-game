<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¸Œæœ›æ—…ç¨‹</title>
  <style>
    :root{
      --bg:#0f172a;       /* slate-900 */
      --panel:#111827ee;   /* gray-900/93 */
      --card:#0b1222;      /* dark card */
      --muted:#9ca3af;     /* gray-400 */
      --acc:#22c55e;       /* green-500 */
      --acc-2:#38bdf8;     /* sky-400 */
      --warn:#f59e0b;      /* amber-500 */
      --danger:#ef4444;    /* red-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, #1e293b 0%, #0b1020 45%, var(--bg) 100%);
      color:#e5e7eb; overflow:hidden;
    }
    .app{display:grid; grid-template-columns: 320px 1fr 360px; gap:16px; height:100%; padding:16px}
    @media (max-width: 1100px){.app{grid-template-columns:1fr; grid-template-rows:auto auto 1fr; overflow:auto}}
    .panel{background:linear-gradient(180deg, #0c1428 0%, #0a0f1d 100%); border:1px solid #1f2a44; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);height: 100%;display: flex;flex-direction: column;}
    h1{margin:0 0 6px; font-size:22px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px}
    .row{display:flex; gap:8px; align-items:center}
    .stack{display:flex; flex-direction:column; gap:8px}
    .kpi{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
    .kpi .card{background:var(--card); border:1px solid #1e293b; border-radius:12px; padding:10px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .val{font-weight:700; font-size:20px}
    .money{font-size:28px; font-weight:800}
    .pill{padding:4px 8px; background:#0f172a; border:1px solid #1f2a44; border-radius:999px; font-size:12px; color:var(--muted)}
    .btn{cursor:pointer; background:linear-gradient(180deg, #12325a 0%, #0d2545 100%); border:1px solid #1e3a5f; border-radius:12px; padding:10px 12px; color:#e5e7eb; font-weight:600}
    .btn:hover{filter:brightness(1.1)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn-acc{background:linear-gradient(180deg, #1f9e54 0%, #157d3f 100%); border-color:#1a7a45}
    .btn-warn{background:linear-gradient(180deg, #b97709 0%, #946107 100%); border-color:#9a6b09}
    .btn-ghost{background:#0a1222; border-color:#1f2a44}

    .progress{height:8px; background:#0b1222; border-radius:999px; overflow:hidden; border:1px solid #1f2a44}
    .bar{height:100%; background:linear-gradient(90deg, var(--acc), var(--acc-2)); width:0%}

    .cards{display:flex; flex-direction:column; gap:12px; overflow:auto; padding-right:4px;flex-grow: 1;}
    .card{background:linear-gradient(180deg, #0f1a32 0%, #0b1222 100%); border:1px solid #1f2a44; border-radius:16px; padding:14px}
    .card h3{margin:0 0 6px}
    .muted{color:var(--muted)}
    .right .project{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #1f2a44; color:#cbd5e1; background:#0b1222}
    .statrow{display:grid; grid-template-columns:1fr 1fr; gap:6px}
    .meter{height:8px; background:#0b1222; border:1px solid #1f2a44; border-radius:8px; overflow:hidden}
    .meter > span{display:block; height:100%; background:linear-gradient(90deg, #60a5fa, #34d399); width:50%}

    .sticky-footer{position:sticky; bottom:0; background:linear-gradient(180deg, #0b1222cc, #0b1222); border-top:1px solid #1f2a44; margin-top:8px; padding:12px; border-radius:14px}
    .foot-grid{display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center}

    .mini{font-size:12px}
    
    #fixed-footer {
      position: fixed;
      bottom: 12px;
      right: 12px;
      z-index: 1000;
      background: linear-gradient(180deg, #0b1222cc, #0b1222);
      border: 1px solid #1f2a44;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
      transition: all 0.5s ease-in-out;
      width: auto;
      transform-origin: bottom right;
    }
    #fixed-footer.shrink {
      width: auto;
      padding: 10px 14px;
      transform: scale(0.8);
      cursor: pointer;
    }
    #fixed-footer.shrink > .foot-grid > div {
      display: none;
    }
    #fixed-footer.shrink .btn {
      width: 48px;
      height: 48px;
      padding: 0;
      font-size: 0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #fixed-footer.shrink .btn:first-child { display: none; }
    #fixed-footer.shrink .btn:last-child { margin-left: -8px; }
    #fixed-footer.shrink .btn-acc::before {
      content: "âœ…";
      font-size: 24px;
    }

    /* æ–°å¢çš„ç¤¾ç¾¤ä¿¡ä»»æ¨£å¼ */
    .trust-gauge {
      position: relative;
      height: 20px;
      background: #444; /* é»‘æš—åº•è‰² */
      border-radius: 10px;
      overflow: hidden;
      margin-top: 4px;
    }
    .trust-bar {
      height: 100%;
      width: var(--trust-val);
      background: linear-gradient(90deg, #a1a1aa, #34d399); /* ç°è‰²åˆ°ç¶ è‰²æ¼¸å±¤ */
      transition: background-color 0.5s ease;
      position: relative;
    }
    .trust-pointer {
      position: absolute;
      left: 50%;
      height: 100%;
      width: 2px;
      background: #e5e7eb;
      transform: translateX(-50%);
      z-index: 1;
    }
    .trust-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .trust-label.left { left: 10%; }
    .trust-label.right { left: 90%; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel stack">
      <div>
        <h1>ğŸ¡ å¸Œæœ›æ—…ç¨‹</h1>
        <div class="sub">å¡å…§åŠ çˆ¾çƒæ˜Ÿ Sadio ManÃ© çš„äººç”Ÿæ•…äº‹ï¼Œè¦‹è­‰ ~åœ¨çƒå ´å¤–ï¼Œç‚ºå®¶é„‰å‰µé€ å¸Œæœ›çš„åŠ›é‡ï¼Œä½ ä¹Ÿå¯ä»¥åšåˆ°ã€‚</div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="label">å¯ç”¨è³‡é‡‘</div>
          <div class="money" id="money">$0</div>
        </div>
        <div class="card">
          <div class="label">æœˆä»½ï¼å¹´</div>
          <div class="val"><span id="month">1</span> / <span id="year">1</span>å¹´</div>
        </div>
        <div class="card">
          <div class="label">æœˆæ”¶å…¥ï¼ˆè·æ¶¯ï¼‰</div>
          <div class="val" id="income">$0</div>
        </div>
        <div class="card">
          <div class="label">ç¤¾ç¾¤ä¿¡ä»»</div>
          <div class="trust-gauge">
            <div class="trust-pointer"></div>
            <div class="trust-bar" id="trustBar"></div>
          </div>
          <div class="sub" style="text-align:center; margin-top:4px;display:flex; justify-content: space-between;">
            <span>é»‘æš—</span><span>å¹³æ·¡</span><span>å…‰æ˜</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="label">å†å‰é€²ä¸€é»</div>
            <div class="progress" aria-label="å½±éŸ¿åŠ›é€²åº¦">
              <div class="bar" id="impactBar"></div>
            </div>
          </div>
          <div class="pill" id="impactScore">0 åˆ†</div>
        </div>
      </div>

      <div class="card">
        <div class="label">æ‰€è¦‹çš„éœ€è¦</div>
        <div class="statrow">
          <div>
            æ•™è‚²
            <div class="meter"><span id="eduMeter" style="width:20%"></span></div>
          </div>
          <div>
            é†«ç™‚
            <div class="meter"><span id="healthMeter" style="width:20%"></span></div>
          </div>
          <div>
            ç”¨æ°´
            <div class="meter"><span id="waterMeter" style="width:20%"></span></div>
          </div>
          <div>
            å°±æ¥­
            <div class="meter"><span id="jobsMeter" style="width:20%"></span></div>
          </div>
          <div>
            é«”è‚²
            <div class="meter"><span id="sportsMeter" style="width:20%"></span></div>
          </div>
          <div>
            é‹è¡Œ
            <div class="meter"><span id="maintMeter" style="width:50%"></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="btn btn-ghost" id="saveBtn">ğŸ’¾ ä¸»å‹•ä¼‘æ¯</button>
        <button class="btn btn-ghost" id="loadBtn">ğŸ“‚ è¼‰å…¥</button>
        <button class="btn btn-warn" id="resetBtn">ğŸ—‘ï¸ éŠæˆ²å¯é‡ä¾†</button>
      </div>
    </aside>

    <main class="panel">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h1>ğŸ“œ æœ¬æœˆäº‹ä»¶</h1>
          <div class="sub">æ ¹æ“šäº‹ä»¶åšæŠ‰æ“‡ï¼Œä½ çš„æ±ºå®šå½±éŸ¿è‘—æ‰€çœ‹è¦‹çš„éœ€è¦èˆ‡è²¡å‹™ã€‚</div>
        </div>
        <div class="pill" id="villageTag">ğŸ˜ï¸ å®¶é„‰ï¼šæœªå‘½å</div>
      </div>

      <div class="cards" id="eventList" aria-live="polite"></div>
    </main>

    <aside class="panel right stack">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h1>ğŸ§­ å°ˆæ¡ˆé¸å–®</h1>
          <div class="sub">é¸æ“‡æƒ³è¡Œå‹•çš„åœ¨åœ°å°ˆæ¡ˆï¼ˆå¯é‡è¤‡å»ºç½®åœ¨ä¸åŒåœ°æ–¹ï¼‰ã€‚</div>
        </div>
        <button class="btn" id="renameBtn">âœï¸ è¨­å®šå®¶é„‰åç¨±</button>
      </div>

      <div class="cards" id="projectList"></div>
    </aside>
  </div>

  <div id="fixed-footer" class="active">
    <div class="foot-grid">
      <div class="mini muted">
        æç¤ºï¼šæ¯å€‹æœˆæœƒè‡ªå‹•çµç®—é‹è¡Œæˆæœ¬èˆ‡å¸¶ä¾†çš„é•·æœŸæ”¶ç›Šã€‚ç¤¾ç¾¤ä¿¡ä»»æœƒå½±éŸ¿å‹Ÿè³‡èˆ‡å¿—å·¥åƒèˆ‡ã€‚
      </div>
      <button class="btn" id="skipBtn">â¡ï¸ ç¦±å‘Š</button>
      <button class="btn btn-acc" id="nextBtn">âœ… è¡Œå‹•</button>
    </div>
  </div>

  <script>
    // éŠæˆ²æ ¸å¿ƒç‹€æ…‹
    const Game = {
      month: 1,
      year: 1,
      money: 1, // åˆå§‹è³‡é‡‘
      baseIncome: 10000, // æ¯æœˆè·æ¶¯æ”¶å…¥ï¼ˆå¯æƒ³åƒç‚ºåˆç´„èˆ‡ä»£è¨€ï¼‰
      trust: 50, // 0-100
      metrics: { edu:20, health:20, water:20, jobs:20, sports:20, maint:50 }, // 0-100
      villageName: "æœªå‘½å",
      projects: [], // å»ºç½®ä¸­çš„å°ˆæ¡ˆ
      history: [], // äº‹ä»¶ç´€éŒ„
    };

    // å°ˆæ¡ˆè—åœ–ï¼ˆå¯è‡ªç”±æ“´å……ï¼‰
    const PROJECT_CATALOG = [
      {
        id:"school", name:"ğŸ“š å°å­¸ç¿»ä¿®", cost: 90000, monthlyUpkeep: 4000,
        effects:{ edu:+8, jobs:+1, maint:-1 }, longTerm:"æå‡å…¥å­¸ç‡èˆ‡å¸«è³‡æ„é¡˜"
      },
      {
        id:"clinic", name:"ğŸ¥ åŸºç¤è¨ºç™‚ç«™", cost: 120000, monthlyUpkeep: 6000,
        effects:{ health:+10, jobs:+1, maint:-2 }, longTerm:"é™ä½å¯é¿å…çš„ç–¾ç—…é¢¨éšª"
      },
      {
        id:"well", name:"ğŸš° æ·±æ°´äº•èˆ‡æ·¨æ°´", cost: 70000, monthlyUpkeep: 2000,
        effects:{ water:+12, health:+2, maint:-1 }, longTerm:"æ”¹å–„ç”¨æ°´ï¼Œæ¸›å°‘å–æ°´æ™‚é–“"
      },
      {
        id:"academy", name:"âš½ å°‘å¹´è¶³çƒè¨“ç·´ä¸­å¿ƒ", cost: 60000, monthlyUpkeep: 3000,
        effects:{ sports:+10, edu:+2, jobs:+1, maint:-1 }, longTerm:"ä»¥é‹å‹•å¸¶å‹•å‘ä¸Šèˆ‡å‡èš"
      },
      {
        id:"micro", name:"ğŸ’¼ å¾®å‹å‰µæ¥­åŸºé‡‘", cost: 50000, monthlyUpkeep: 2000,
        effects:{ jobs:+8, trust:+3 }, longTerm:"æ”¯æŒå°åº—èˆ‡å®¶åº­ç”Ÿè¨ˆ"
      },
      {
        id:"solar", name:"ğŸ”† å¤ªé™½èƒ½è·¯ç‡ˆ", cost: 40000, monthlyUpkeep: 1000,
        effects:{ trust:+2, jobs:+1, maint:+1 }, longTerm:"æé«˜å¤œé–“å®‰å…¨èˆ‡æ´»å‹•"
      },
      {
        id:"communityMeal", name:"ğŸ² ç¤¾å€å…è²»é¤æœƒ", cost: 20000, monthlyUpkeep: 3000,
        effects:{ trust:+8, maint:+2 }, longTerm:"æä¾›å¼±å‹¢é¤é£Ÿï¼Œå¢é€²ç¤¾ç¾¤é—œä¿‚"
      },
      {
        id:"youthClub", name:"ğŸ€ é’å°‘å¹´é€±æœ«æ´»å‹•", cost: 30000, monthlyUpkeep: 2000,
        effects:{ edu:+5, sports:+4, trust:+4 }, longTerm:"å¸¶é ˜é’å°‘å¹´æ­£å‘æ´»å‹•ï¼Œå»ºç«‹ä¿¡ä»»"
      },
      {
        id:"elderVisit", name:"ğŸ‘µ é•·è€…é—œæ‡·æ¢è¨ª", cost: 2000, monthlyUpkeep: 1000,
        effects:{ trust:+6, maint:+1 }, longTerm:"æ¢è¨ªé•·è€…ï¼Œå‚³éé—œæ‡·èˆ‡é™ªä¼´"
      },
      {
        id:"afterSchool", name:"ğŸ“š æ”¾å­¸è¼”å°ç­", cost: 4000, monthlyUpkeep: 2500,
        effects:{ edu:+8, trust:+3 }, longTerm:"è¼”å°å¼±å‹¢å­¸ç”Ÿï¼Œæå‡å­¸ç¿’èˆ‡ä¿¡ä»»"
      },
      {
        id:"healthCheck", name:"ğŸ©º ç¤¾å€å¥åº·æª¢æŸ¥", cost: 50000, monthlyUpkeep: 3000,
        effects:{ health:+8, trust:+4 }, longTerm:"æä¾›åŸºæœ¬å¥åº·æª¢æŸ¥ï¼Œå¢å¼·ç¤¾ç¾¤å¥åº·æ„è­˜"
      },
      {
        id:"musicMinistry", name:"ğŸµ ç¤¾å€éŸ³æ¨‚æœäº‹", cost: 3000, monthlyUpkeep: 1000,
        effects:{ trust:+3, edu:+2 }, longTerm:"é€ééŸ³æ¨‚å¸¶ä¾†ç¥ç¦èˆ‡ç¤¾ç¾¤å‡èš"
      },
      {
        id:"workshopSkills", name:"ğŸ› ï¸ ç¤¾å€æŠ€èƒ½å·¥ä½œåŠ", cost: 35000, monthlyUpkeep: 3000,
        effects:{ jobs:+5, edu:+4, trust:+3 }, longTerm:"æ•™å°ç”Ÿæ´»èˆ‡å·¥ä½œæŠ€èƒ½ï¼Œæå‡è‡ªç«‹èƒ½åŠ›"
      },
      {
        id:"cleanUpDay", name:"ğŸ§¹ ç¤¾å€æ¸…æ½”æ—¥", cost: 5000, monthlyUpkeep: 1000,
        effects:{ maint:+5, trust:+2 }, longTerm:"çµ„ç¹”ç¤¾å€æ¸…æ½”æ´»å‹•ï¼Œæ”¹å–„å±…ä½ç’°å¢ƒ"
      },
      {
        id:"charityDrive", name:"ğŸ ç¤¾å€ç‰©è³‡æè´ˆ", cost: 6000, monthlyUpkeep: 1000,
        effects:{ trust:+6, maint:+1 }, longTerm:"æ”¶é›†èˆ‡åˆ†ç™¼ç‰©è³‡çµ¦æœ‰éœ€è¦çš„äºº"
      },
      {
        id:"storyTime", name:"ğŸ“– ç¤¾å€è¦ªå­èªªæ•…äº‹", cost: 8000, monthlyUpkeep: 700,
        effects:{ edu:+3, trust:+3 }, longTerm:"é€éè¦ªå­æ•…äº‹æ´»å‹•å»ºç«‹è‰¯å¥½ç¤¾å€äº’å‹•"
      },
      {
        id:"streetArt", name:"ğŸ¨ è¡—é ­è—è¡“è¨ˆç•«", cost: 40000, monthlyUpkeep: 2000,
        effects:{ trust:+5, edu:+2 }, longTerm:"ç¾åŒ–ç¤¾å€ç’°å¢ƒï¼Œå¸å¼•è§€å…‰èˆ‡å‰µæ„äººæ‰"
      },
      {
        id:"recycleHub", name:"â™»ï¸ ç¤¾å€è³‡æºå›æ”¶ä¸­å¿ƒ", cost: 50000, monthlyUpkeep: 1000,
        effects:{ maint:+3, trust:+2 }, longTerm:"æå‡ç’°ä¿æ„è­˜ï¼Œæ¸›å°‘æµªè²»"
      },
      {
        id:"techLab", name:"ğŸ’» å‰µå®¢å¯¦é©—å®¤", cost: 90000, monthlyUpkeep: 2500,
        effects:{ edu:+8, jobs:+5, trust:+3 }, longTerm:"åŸ¹é¤Šç§‘æŠ€æŠ€èƒ½èˆ‡å‰µæ¥­èƒ½åŠ›"
      },
      {
        id:"elderCare", name:"ğŸ‘µ é•·è€…é—œæ‡·ä¸­å¿ƒ", cost: 80000, monthlyUpkeep: 1500,
        effects:{ trust:+6, maint:+1 }, longTerm:"æå‡ç¤¾å€é—œæ‡·èˆ‡è€äººç¦ç¥‰"
      },
      {
        id:"urbanGarden", name:"ğŸŒ¿ éƒ½å¸‚å…±äº«èŠ±åœ’", cost: 30000, monthlyUpkeep: 1000,
        effects:{ edu:+2, trust:+3, maint:+2 }, longTerm:"æ”¹å–„åŸå¸‚ç¶ åŒ–èˆ‡ç¤¾ç¾¤äº’å‹•"
      },
      {
        id:"culturalFest", name:"ğŸ­ ç¤¾å€æ–‡åŒ–ç¯€", cost: 60000, monthlyUpkeep: 2000,
        effects:{ trust:+8, edu:+2 }, longTerm:"ä¿ƒé€²æ–‡åŒ–äº¤æµèˆ‡ç¤¾ç¾¤å‡èš"
      },
      {
        id:"bikeLane", name:"ğŸš´ å®‰å…¨è‡ªè¡Œè»Šé“", cost: 70000, monthlyUpkeep: 3000,
        effects:{ maint:+4, trust:+3 }, longTerm:"é¼“å‹µä½ç¢³é‹è¼¸èˆ‡å¥åº·ç”Ÿæ´»"
      },
      {
        id:"emergencyKit", name:"ğŸ§° ç½å®³æ‡‰è®Šç‰©è³‡åº«", cost: 50000, monthlyUpkeep: 10000,
        effects:{ maint:+5, trust:+2 }, longTerm:"æå‡ç¤¾å€éŸŒæ€§èˆ‡ç·Šæ€¥æ‡‰è®Šèƒ½åŠ›"
      },
      {
        id:"startupFund", name:"ğŸš€ é’å¹´å‰µæ¥­åŸºé‡‘", cost: 100000, monthlyUpkeep: 1000,
        effects:{ jobs:+10, trust:+4 }, longTerm:"æ”¯æŒå¹´è¼•å‰µæ¥­è€…ï¼Œåˆºæ¿€ç¶“æ¿Ÿæ´»åŠ›"
      },
      {
        id:"solarFarm", name:"â˜€ï¸ å°å‹å¤ªé™½èƒ½è¾²å ´", cost: 120000, monthlyUpkeep: 3000,
        effects:{ trust:+3, maint:+2, jobs:+2 }, longTerm:"ç”Ÿç”¢å†ç”Ÿèƒ½æºï¼Œæ”¹å–„ç’°å¢ƒèˆ‡å°±æ¥­"
      }
    ];

    // éš¨æ©Ÿäº‹ä»¶æ± 
    const EVENTS = [
      {
        id:"press",
        text:"åª’é«”é—œæ³¨ä½ çš„å®¶é„‰è¨ˆç•«ï¼Œè‹¥æ¥å—å°ˆè¨ªå¯æå‡ä¿¡ä»»ï¼Œä½†ä½ éœ€å¯¦éš›æŠ•å…¥åˆ°åœ¨åœ°æ´»å‹•ã€‚",
        choices:[
          {label:"æ¥å—ï¼šä¸¦å¯¦éš›æŠ•å…¥ï¼Œéç¨‹èŠ±è²»$10,000ï¼Œä¿¡ä»»+8", apply:s=>{s.money-=10000; s.trust=Math.min(100,s.trust+8)}},
          {label:"å©‰æ‹’ï¼šç„¡èŠ±è²»ï¼Œä¿¡ä»»-3", apply:s=>{s.trust=Math.max(0,s.trust-3)}}
        ]
      },
      {
        id:"flood",
        text:"æš´é›¨é€ æˆé“è·¯å—æï¼Œè‹¥ç«‹å³ä¿®è£œå¯é¿å…é‹è¡Œæƒ¡åŒ–ã€‚",
        choices:[
          {label:"ç·Šæ€¥ä¿®è£œï¼šèŠ±$50,000ï¼Œé‹è¡Œ+6", apply:s=>{s.money-=50000; s.metrics.maint=Math.min(100,s.metrics.maint+6)}},
          {label:"æš«ç·©ï¼šçœéŒ¢ä½†é‹è¡Œ-6", apply:s=>{s.metrics.maint=Math.max(0,s.metrics.maint-6)}}
        ]
      },
      {
        id:"sponsor",
        text:"å“ç‰Œé‚€è«‹å…¬ç›Šè¯åï¼Œè‹¥åƒèˆ‡å¯å¢åŠ æœˆæ”¶å…¥ä½†éœ€æ¯æœˆæŠ•å…¥å¿—å·¥æ™‚æ•¸ï¼ˆé™ä½é‹è¡Œå£“åŠ›ï¼‰ã€‚",
        choices:[
          {label:"åƒèˆ‡ï¼šæœˆæ”¶å…¥+$10,000ï¼Œé‹è¡Œ+2", apply:s=>{s.baseIncome+=10000; s.metrics.maint=Math.min(100,s.metrics.maint+2)}},
          {label:"ä¸åƒèˆ‡ï¼šä¿æŒç¾ç‹€", apply:s=>{}}
        ]
      },
      {
        id:"match",
        text:"æœ¬æœˆè³½äº‹è¡¨ç¾å‡ºè‰²ï¼Œç²å¾—æ¯”è³½çé‡‘$30,000ï¼Œæ˜¯å¦å…¨æ•¸æå…¥åŸºé‡‘ï¼Ÿ",
        choices:[
          {label:"å…¨æ•¸æŠ•å…¥å…¬ç›Šï¼ˆ+ä¿¡ä»»5ï¼‰", apply:s=>{s.trust=Math.min(100,s.trust+5)}},
          {label:"ä¿ç•™ä¸€åŠï¼ˆ+ç¾é‡‘15,000ï¼Œ+ä¿¡ä»»1ï¼‰", apply:s=>{s.money+=15000; s.trust=Math.min(100,s.trust+1)}},
          {label:"è‡ªè¡Œé‹ç”¨ï¼ˆ+ç¾é‡‘30,000ï¼‰", apply:s=>{s.money+=30000}}
        ]
      },
    {
        id:"scandal",
        text:"æœ‰äººè¬ å‚³ä½ æŒªç”¨å…¬ç›Šæ¬¾é …å»è²·è·‘è»Šï¼Œè‹¥ä¸è™•ç†å°‡åš´é‡å½±éŸ¿ä½ çš„è²è­½ã€‚",
        choices:[
          {label:"å…¬é–‹è²¡å‹™æ˜ç´°ï¼šèŠ±$30,000å…¬é—œè²»æ¾„æ¸…ï¼Œä¿¡ä»»+10", apply:s=>{s.money-=30000; s.trust=Math.min(100,s.trust+10)}},
          {label:"å†·è™•ç†ï¼šä¸å›æ‡‰è¬ è¨€ï¼Œä¿¡ä»»-20", apply:s=>{s.trust=Math.max(0,s.trust-20)}}
        ]
      },
      {
        id:"fundraiser",
        text:"ç•¶åœ°ä¼æ¥­çœ‹è¦‹äº†ä½ çš„åŠªåŠ›ï¼Œé¡˜æ„èˆ‰è¾¦ä¸€å ´è¯åˆæ…ˆå–„å‹Ÿæ¬¾ï¼Œä½†éœ€æŠ•å…¥äººåŠ›å”è¾¦ã€‚",
        choices:[
          {label:"å…¨åŠ›å”è¾¦ï¼šèŠ±è²»$10,000äººåŠ›æˆæœ¬ï¼Œéš¨æ©Ÿç²å¾—$6~$30,000å‹Ÿæ¬¾", apply:s=>{s.money-=10000; s.money+=Math.floor(Math.random()*(30000-6+1))+6;;}},
          {label:"å©‰æ‹’ï¼šå°ˆæ³¨ç•¶ä¸‹å°ˆæ¡ˆï¼Œç„¡æ”¶ç›Šä¹Ÿç„¡èŠ±è²»", apply:s=>{}}
        ]
      },
      {
        id:"volunteer",
        text:"ç¤¾ç¾¤è‡ªç™¼æ€§çµ„ç¹”å¿—å·¥åœ˜é«”ï¼Œé¡˜æ„ç‚ºä½ çš„å°ˆæ¡ˆæä¾›ç„¡å„Ÿå‹åŠ›ï¼Œä½†éœ€è¦ä½ æä¾›ç‰©è³‡æ”¯æŒã€‚",
        choices:[
          {label:"æä¾›ç‰©è³‡ï¼šèŠ±$3,000ï¼Œéš¨æ©Ÿæå‡ä»»ä¸€æŒ‡æ¨™+5", apply:s=>{const metrics = ['edu', 'health', 'water', 'jobs', 'sports', 'maint']; const randomMetric = metrics[Math.floor(Math.random()*metrics.length)]; s.money-=3000; s.metrics[randomMetric]=Math.min(100, s.metrics[randomMetric]+5);}},
          {label:"ç„¡åŠ›æ”¯æŒï¼šæ„Ÿè¬ä»–å€‘çš„å¥½æ„ï¼Œä½†ç„¡åŠ›æ”¯æŒï¼Œä¿¡ä»»-5", apply:s=>{s.trust=Math.max(0, s.trust-5);}}
        ]
      },
      {
        id:"policy",
        text:"æ”¿åºœè€ƒæ…®æ¨å‹•ä¸€é …æ–°æ”¿ç­–ï¼Œå°‡å½±éŸ¿ä½ éƒ¨åˆ†å°ˆæ¡ˆçš„åˆæ³•æ€§ã€‚",
        choices:[
          {label:"ç™¼æ®å½±éŸ¿åŠ›ï¼šç±Œè¾¦è¬›åº§ï¼Œéç¨‹èŠ±è²»$50,000ï¼Œæå‡ä¿¡ä»»+5ï¼Œä¸¦é¿å…é‹è¡Œ-8", apply:s=>{s.money-=50000; s.trust=Math.min(100,s.trust+5);}},
          {label:"ä¸ä»‹å…¥ï¼šçœä¸‹è²»ç”¨ï¼Œä½†é‹è¡Œ-8", apply:s=>{s.metrics.maint=Math.max(0, s.metrics.maint-8);}}
        ]
      },
      {
        id:"media",
        text:"ç•¶åœ°åª’é«”æƒ³æ‹æ”ä¸€éƒ¨é—œæ–¼ä½ çš„ç´€éŒ„ç‰‡ï¼Œé€™èƒ½è®“ä½ çš„è¨ˆç•«å»£ç‚ºäººçŸ¥ï¼Œä½†éœ€è¦èŠ±æ™‚é–“é…åˆã€‚",
        choices:[
          {label:"åŒæ„æ‹æ”ï¼šä¿¡ä»»+8ï¼Œæ¥ä¸‹ä¾†æœˆæ”¶å…¥é¡å¤–å¢åŠ $200", apply:s=>{s.trust=Math.min(100,s.trust+8); s.baseIncome+=200;}},
          {label:"æ‹’çµ•ï¼šç„¡è®ŠåŒ–", apply:s=>{}}
        ]
      },
{
  id: "waterCrisis",
  text: "ç¤¾å€çš„ä¸»è¦æ°´äº•å‡ºç¾æ±¡æŸ“å«Œç–‘ï¼Œå±…æ°‘é–‹å§‹æŠ±æ€¨é£²ç”¨æ°´å“è³ªã€‚",
  choices: [
    {
      label: "æŠ•è³‡æ·¨æ°´ç³»çµ±ï¼šèŠ±è²»$8,000ï¼Œæ°´æŒ‡æ¨™+10ï¼Œé‹è¡Œ+3",
      apply: s => {
        s.money -= 8000;
        s.metrics.water = clamp(s.metrics.water + 10, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 3, 0, 100);
      }
    },
    {
      label: "æ¨å»£ç¯€æ°´æ•™è‚²ï¼šèŠ±è²»$1,500ï¼Œæ°´æŒ‡æ¨™+4ï¼Œä¿¡ä»»+3",
      apply: s => {
        s.money -= 1500;
        s.metrics.water = clamp(s.metrics.water + 4, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "ä¸ä½œç‚ºï¼šç„¡èŠ±è²»ï¼Œæ°´æŒ‡æ¨™-6ï¼Œä¿¡ä»»-5",
      apply: s => {
        s.metrics.water = Math.max(0, s.metrics.water - 6);
        s.trust = Math.max(0, s.trust - 5);
      }
    }
  ]
},

// 2. å­¸æ ¡å‡ç´šææ¡ˆ
{
  id: "schoolUpgrade",
  text: "ç•¶åœ°å°å­¸è«‹æ±‚å”åŠ©ç¿»æ–°æ•™å®¤ï¼Œå­©å­å€‘æœŸå¾…æ›´å¥½çš„å­¸ç¿’ç’°å¢ƒã€‚",
  choices: [
    {
      label: "å…¨é¡è´ŠåŠ©ï¼šèŠ±è²»$10,000ï¼Œæ•™è‚²+12ï¼Œä¿¡ä»»+5",
      apply: s => {
        s.money -= 10000;
        s.metrics.edu = clamp(s.metrics.edu + 12, 0, 100);
        s.trust = clamp(s.trust + 5, 0, 100);
      }
    },
    {
      label: "å°‹æ±‚ä¼æ¥­è´ŠåŠ©ï¼šèŠ±è²»$2,000ï¼Œå°±æ¥­+3ï¼Œæ•™è‚²+6ï¼Œé‹è¡Œ+2",
      apply: s => {
        s.money -= 2000;
        s.metrics.jobs = clamp(s.metrics.jobs + 3, 0, 100);
        s.metrics.edu = clamp(s.metrics.edu + 6, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "å°‡ææ¡ˆæ“±ç½®ï¼šä¿¡ä»»-4ï¼Œæ•™è‚²-3",
      apply: s => {
        s.trust = Math.max(0, s.trust - 4);
        s.metrics.edu = Math.max(0, s.metrics.edu - 3);
      }
    }
  ]
},

// 3. åœ°å€é‹å‹•æœƒ
{
  id: "sportsFestival",
  text: "éš”å£æ‘æƒ³èˆ‰è¾¦åœ°å€é‹å‹•æœƒï¼Œé‚€è«‹ä½ çš„ç¤¾å€åƒèˆ‡ä¸¦æ‰¿è¾¦éƒ¨åˆ†è³½äº‹ã€‚",
  choices: [
    {
      label: "æ‰¿è¾¦é–‹å¹•å„€å¼ï¼šèŠ±è²»$7,000ï¼Œé«”è‚²+10ï¼Œä¿¡ä»»+4ï¼Œé‹è¡Œ+5",
      apply: s => {
        s.money -= 7000;
        s.metrics.sports = clamp(s.metrics.sports + 10, 0, 100);
        s.trust = clamp(s.trust + 4, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 5, 0, 100);
      }
    },
    {
      label: "åªæ´¾éšŠåƒåŠ ï¼šèŠ±è²»$1,200ï¼Œé«”è‚²+5ï¼Œä¿¡ä»»+2",
      apply: s => {
        s.money -= 1200;
        s.metrics.sports = clamp(s.metrics.sports + 5, 0, 100);
        s.trust = clamp(s.trust + 2, 0, 100);
      }
    },
    {
      label: "å©‰æ‹’é‚€è«‹ï¼šä¿¡ä»»-3",
      apply: s => {
        s.trust = Math.max(0, s.trust - 3);
      }
    }
  ]
},

// 4. å¥åº·æª¢æ¸¬è¡Œå‹•
{
  id: "healthCheck",
  text: "å…¬å…±è¡›ç”Ÿçµ„ç¹”æä¾›å…è²»å¥åº·æª¢æ¸¬ï¼Œä½†éœ€æ´¾å“¡å”åŠ©å ´åœ°èˆ‡å¾Œå‹¤ã€‚",
  choices: [
    {
      label: "æä¾›å ´åœ°æ”¯æ´ï¼šèŠ±è²»$3,000ï¼Œé†«ç™‚+8ï¼Œä¿¡ä»»+3",
      apply: s => {
        s.money -= 3000;
        s.metrics.health = clamp(s.metrics.health + 8, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "åªæ´¾å¿—é¡˜è€…ï¼šé†«ç™‚+4ï¼Œä¿¡ä»»+2",
      apply: s => {
        s.metrics.health = clamp(s.metrics.health + 4, 0, 100);
        s.trust = clamp(s.trust + 2, 0, 100);
      }
    },
    {
      label: "æ‹’çµ•åˆä½œï¼šé†«ç™‚-5ï¼Œä¿¡ä»»-4",
      apply: s => {
        s.metrics.health = Math.max(0, s.metrics.health - 5);
        s.trust = Math.max(0, s.trust - 4);
      }
    }
  ]
},

// 5. ç’°ä¿è£œåŠ©è¨ˆç•«
{
  id: "greenGrant",
  text: "åœ‹éš›åŸºé‡‘æœƒæä¾›ç¶ èƒ½è£œåŠ©ï¼Œä½ å¯ä»¥ç”³è«‹å¤ªé™½èƒ½æ¿æˆ–ç¯€èƒ½è¡—ç‡ˆã€‚",
  choices: [
    {
      label: "è£è¨­å¤ªé™½èƒ½æ¿ï¼šèŠ±è²»$12,000ï¼Œç”¨æ°´+5ï¼Œé‹è¡Œ+6ï¼Œä¿¡ä»»+5",
      apply: s => {
        s.money -= 12000;
        s.metrics.water = clamp(s.metrics.water + 5, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 6, 0, 100);
        s.trust = clamp(s.trust + 5, 0, 100);
      }
    },
    {
      label: "æ›æˆç¯€èƒ½è¡—ç‡ˆï¼šèŠ±è²»$6,000ï¼Œé‹è¡Œ+4ï¼Œä¿¡ä»»+3",
      apply: s => {
        s.money -= 6000;
        s.metrics.maint = clamp(s.metrics.maint + 4, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "æ”¾æ£„ç”³è«‹ï¼šä¿¡ä»»-2",
      apply: s => {
        s.trust = Math.max(0, s.trust - 2);
      }
    }
  ]
},
// 1. è‡¨æ™‚åœé›»
{
  id: "powerOutage",
  text: "ç¤¾å€çªç™¼çŸ­æš«åœé›»ï¼Œå±…æ°‘æŠ±æ€¨å®¶ç”¨é›»å™¨å¯èƒ½å—æã€‚",
  choices: [
    {
      label: "æä¾›è‡¨æ™‚ç…§æ˜èˆ‡å°é¡è£œåŠ©ï¼šèŠ±è²»$800ï¼Œé†«ç™‚+3ï¼Œä¿¡ä»»+4",
      apply: s => {
        s.money -= 800;
        s.metrics.health = clamp(s.metrics.health + 3, 0, 100);
        s.trust = clamp(s.trust + 4, 0, 100);
      }
    },
    {
      label: "ç”³è«‹ç·Šæ€¥ç¶­ä¿®éšŠï¼šèŠ±è²»$1,200ï¼Œé‹è¡Œ+6ï¼Œä¿¡ä»»+2",
      apply: s => {
        s.money -= 1200;
        s.metrics.maint = clamp(s.metrics.maint + 6, 0, 100);
        s.trust = clamp(s.trust + 2, 0, 100);
      }
    },
    {
      label: "è®“å±…æ°‘è‡ªç†ï¼šä¿¡ä»»-5",
      apply: s => {
        s.trust = Math.max(0, s.trust - 5);
      }
    }
  ]
},

// 2. è·¯é¢å‘æ´
{
  id: "roadPothole",
  text: "ä¸»è¦é“è·¯å‡ºç¾å‘æ´ï¼Œè¡Œäººå’Œè»Šè¼›éƒ½å®¹æ˜“å—æã€‚",
  choices: [
    {
      label: "ç·Šæ€¥ä¿®è£œï¼šèŠ±è²»$1,500ï¼Œé‹è¡Œ+5ï¼Œä¿¡ä»»+4",
      apply: s => {
        s.money -= 1500;
        s.metrics.maint = clamp(s.metrics.maint + 5, 0, 100);
        s.trust = clamp(s.trust + 4, 0, 100);
      }
    },
    {
      label: "æ’ç¨‹ä¾‹è¡Œç¶­ä¿®ï¼šèŠ±è²»$500ï¼Œé‹è¡Œ+2",
      apply: s => {
        s.money -= 500;
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "å¿½è¦–ä¸ç†ï¼šé‹è¡Œ-4ï¼Œä¿¡ä»»-3",
      apply: s => {
        s.metrics.maint = Math.max(0, s.metrics.maint - 4);
        s.trust = Math.max(0, s.trust - 3);
      }
    }
  ]
},

// 3. ç¤¾å€æµæµªçŠ¬
{
  id: "strayDog",
  text: "ç¤¾å€å‡ºç¾æµæµªçŠ¬ï¼Œéƒ¨åˆ†å±…æ°‘æ“”å¿ƒå®‰å…¨èˆ‡è¡›ç”Ÿå•é¡Œã€‚",
  choices: [
    {
      label: "æˆç«‹è‡¨æ™‚æ”¶å®¹ä¸­å¿ƒï¼šèŠ±è²»$1,000ï¼Œé†«ç™‚+4ï¼Œä¿¡ä»»+5",
      apply: s => {
        s.money -= 1000;
        s.metrics.health = clamp(s.metrics.health + 4, 0, 100);
        s.trust = clamp(s.trust + 5, 0, 100);
      }
    },
    {
      label: "é¼“å‹µå±…æ°‘èªé¤Šï¼šé†«ç™‚+2ï¼Œä¿¡ä»»+3",
      apply: s => {
        s.metrics.health = clamp(s.metrics.health + 2, 0, 100);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "ä¸ç†æœƒï¼šé†«ç™‚-3ï¼Œä¿¡ä»»-4",
      apply: s => {
        s.metrics.health = Math.max(0, s.metrics.health - 3);
        s.trust = Math.max(0, s.trust - 4);
      }
    }
  ]
},

// 4. é„°é‡Œå™ªéŸ³æŠ•è¨´
{
  id: "noiseComplaint",
  text: "å¤œæ™šèšæœƒéŸ³é‡éå¤§ï¼Œé™„è¿‘å±…æ°‘æŠ•è¨´ä¸æ–·ä¸Šé–€ã€‚",
  choices: [
    {
      label: "å”åŠ©å”èª¿é™å™ªï¼šèŠ±è²»$200ï¼Œä¿¡ä»»+4ï¼Œé‹è¡Œ+1",
      apply: s => {
        s.money -= 200;
        s.trust = clamp(s.trust + 4, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 1, 0, 100);
      }
    },
    {
      label: "ç™¼å¸ƒç¤¾å€å®‰å¯§å®ˆå‰‡ï¼šèŠ±è²»$100ï¼Œä¿¡ä»»+2ï¼Œé‹è¡Œ+2",
      apply: s => {
        s.money -= 100;
        s.trust = clamp(s.trust + 2, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "ä¸æ¡å–è¡Œå‹•ï¼šä¿¡ä»»-3",
      apply: s => {
        s.trust = Math.max(0, s.trust - 3);
      }
    }
  ]
},

// 5. å°å‹ç¾©è³£å¸‚é›†
{
  id: "communityBazaar",
  text: "å±…æ°‘æè­°åœ¨å»£å ´èˆ‰è¾¦ç¾©è³£å¸‚é›†ï¼Œå‹Ÿé›†è³‡é‡‘æ”¹å–„ç¤¾å€è¨­æ–½ã€‚",
  choices: [
    {
      label: "ä¸»è¾¦ç¾©è³£ï¼šèŠ±è²»$2,000ï¼Œå‹Ÿæ¬¾$3,000ï¼Œä¿¡ä»»+6ï¼Œé‹è¡Œ+2",
      apply: s => {
        s.money -= 2000;
        s.money = clamp(s.money + 3000, 0, Infinity);
        s.trust = clamp(s.trust + 6, 0, 100);
        s.metrics.maint = clamp(s.metrics.maint + 2, 0, 100);
      }
    },
    {
      label: "åƒ…è³‡åŠ©æ”¤ä½ï¼šèŠ±è²»$500ï¼Œå‹Ÿæ¬¾$800ï¼Œä¿¡ä»»+3",
      apply: s => {
        s.money -= 500;
        s.money = clamp(s.money + 800, 0, Infinity);
        s.trust = clamp(s.trust + 3, 0, 100);
      }
    },
    {
      label: "éŒ¯éæ©Ÿæœƒï¼šä¿¡ä»»-4",
      apply: s => {
        s.trust = Math.max(0, s.trust - 4);
      }
    }
  ]
}
    ];

    // å·¥å…·
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const fmt = n => "$"+ n.toLocaleString();

    // ç‹€æ…‹æ¸²æŸ“
    function renderState(){
      $('#money').textContent = fmt(Game.money);
      $('#income').textContent = fmt(Game.baseIncome);
      $('#month').textContent = Game.month;
      $('#year').textContent = Game.year;
      
      // ç¤¾ç¾¤ä¿¡ä»»é•·æ¢åœ–
      const trustBar = $('#trustBar');
      let trustColor, trustBgColor;
      if (Game.trust >= 100) {
        trustColor = '#fcd34d'; // æ·¡é»ƒè‰²å…‰èŠ’
        trustBgColor = '#f59e0b';
      } else if (Game.trust > 50) {
        trustColor = '#34d399'; // è—ç¶ è‰²
        trustBgColor = '#15803d';
      } else {
        trustColor = '#71717a'; // ç°è‰²
        trustBgColor = '#3f3f46';
      }
      trustBar.style.width = Game.trust + '%';
      trustBar.style.background = `linear-gradient(90deg, ${trustBgColor}, ${trustColor})`;
      
      $('#villageTag').textContent = `ğŸ˜ï¸ å®¶é„‰ï¼š${Game.villageName}`;

      // å½±éŸ¿åˆ†æ•¸ï¼ˆç°¡åŒ–ï¼šå„æŒ‡æ¨™å¹³å‡ + ä¿¡ä»»åŠ æ¬Šï¼‰
      const m = Game.metrics; const avg = (m.edu+m.health+m.water+m.jobs+m.sports+m.maint)/6;
      const impact = Math.round(avg*0.7 + Game.trust*0.3);
      const bar = Math.max(0, Math.min(100, impact));
      $('#impactBar').style.width = bar + '%';
      $('#impactScore').textContent = impact + ' åˆ†';

      // æŒ‡æ¨™æ¢
      $('#eduMeter').style.width = m.edu+'%';
      $('#healthMeter').style.width = m.health+'%';
      $('#waterMeter').style.width = m.water+'%';
      $('#jobsMeter').style.width = m.jobs+'%';
      $('#sportsMeter').style.width = m.sports+'%';
      $('#maintMeter').style.width = m.maint+'%';
    }

    // å°ˆæ¡ˆæ¸²æŸ“
    function renderProjects(){
      const box = $('#projectList');
      box.innerHTML = ''; // æ¸…ç©ºå®¹å™¨å…§å®¹

      // ç¢ºä¿æ¯æ¬¡å‘¼å«éƒ½é‡æ–°éš¨æ©Ÿé¸å– 6 å€‹å°ˆæ¡ˆ
      const shuffledCatalog = [...PROJECT_CATALOG].sort(() => 0.5 - Math.random());
      const projectsToShow = shuffledCatalog.slice(0, 6);

      // éæ­·é€™ 6 å€‹å°ˆæ¡ˆä¾†æ¸²æŸ“
      projectsToShow.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'card project';
        el.innerHTML = `
          <div>
            <h3>${p.name}</h3>
            <div class="muted mini">ä¸€æ¬¡æˆæœ¬ï¼š${fmt(p.cost)}ï½œæ¯æœˆç¶­è­·æ”¯å‡ºï¼š${fmt(p.monthlyUpkeep)}<br>${p.longTerm}</div>
            <div class="row" style="gap:6px; flex-wrap:wrap; margin-top:8px">
              ${Object.entries(p.effects).map(([k,v])=>`<span class="tag">${labelOf(k)} ${v>0?'+':''}${v}</span>`).join('')}
            </div>
          </div>
          <div class="stack" style="align-items:end">
            <button class="btn btn-acc" ${Game.money<p.cost?'disabled':''}>æŠ•è³‡</button>
            <span class="pill mini">${Game.money<p.cost?'è³‡é‡‘ä¸è¶³':'å¯å»ºç½®'}</span>
          </div>
        `;
        el.querySelector('button').onclick=()=>buildProject(p);
        box.appendChild(el);
      });

      // å·²å»ºç½®æ¸…å–®
      if(Game.projects.length){
        const list = document.createElement('div');
        list.className='card';
        list.innerHTML = `<h3>å·²å»ºç½®èˆ‡é‹è¡Œ</h3>`;
        Game.projects.forEach((proj,i)=>{
          const row = document.createElement('div');
          row.className='row';
          row.style.justifyContent='space-between';
          row.style.marginTop='6px';
          row.innerHTML = `<div class="mini">${proj.name} <span class="muted">ï¼ˆç¬¬${proj.builtAt.year}å¹´${proj.builtAt.month}æœˆï¼‰</span></div>
                           <div class="pill mini">é‹è¡Œï¼š${fmt(proj.monthlyUpkeep)}</div>`;
          list.appendChild(row);
        })
        box.appendChild(list);
      }
    }

    function labelOf(k){
      return ({edu:'æ•™è‚²',health:'é†«ç™‚',water:'ç”¨æ°´',jobs:'å°±æ¥­',sports:'é«”è‚²',maint:'é‹è¡Œ',trust:'ä¿¡ä»»'})[k]||k;
    }

    // äº‹ä»¶ç”Ÿæˆèˆ‡æ¸²æŸ“
    function drawEvents(){
      const box = $('#eventList');
      box.innerHTML = '';
      const pool = pick(EVENTS, 2 + (Math.random()>0.7?1:0));
      pool.forEach(e=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${emojiFor(e.id)}ï¼š${e.text}</h3>`;
        
        const choicesContainer = document.createElement('div');
        choicesContainer.className = 'choices-container'; // å¯ä»¥æ·»åŠ CSSä¾†ä½ˆå±€æŒ‰éˆ•
        
        e.choices.forEach(c=>{
          const btn = document.createElement('button');
          btn.className='btn';
          btn.textContent=c.label;
          btn.onclick=()=>{
            c.apply(Game);
            renderState();
            disableCard(card);
          };
          choicesContainer.appendChild(btn);
          choicesContainer.appendChild(document.createTextNode(' '));
        });
        card.appendChild(choicesContainer);
        box.appendChild(card);
      });
    }
    
    function emojiFor(id){
      return ({press:'ğŸ“°', flood:'ğŸŒ§ï¸', sponsor:'ğŸ¤', match:'ğŸ¥‡'})[id] || 'ğŸ“Œ';
    }
    
    function disableCard(card){
      [...card.querySelectorAll('button')].forEach(b=>{b.disabled=true; b.classList.add('btn-ghost')});
      const note = document.createElement('div'); note.className='muted mini'; note.textContent='å·²é¸æ“‡'; card.appendChild(document.createElement('br')); card.appendChild(note);
    }

    function buildProject(p){
  if (Game.money < p.cost) return;
  // ä¸€æ¬¡æ€§æˆæœ¬
  Game.money -= p.cost;
  // æ°¸ä¹…æ¸›å°‘æ¯æœˆè·æ¶¯æ”¶å…¥
  Game.baseIncome = Math.max(0, Game.baseIncome - p.monthlyUpkeep);
  // è¨˜éŒ„å»ºç½®æ™‚é–“
  Game.projects.push({
    ...p,
    builtAt: { year: Game.year, month: Game.month }
  });
  // ï¼ˆå¯é¸ï¼‰å¾®å¹…å¢åŠ ä¿¡ä»»
  const trustGain = p.effects.trust ? Math.max(1, p.effects.trust) : 1;
  Game.trust = Math.min(100, Game.trust + trustGain);
  renderState();
  renderProjects();
  toast(`å·²å»ºç½®ï¼š${p.name}ï¼Œæ¯æœˆè·æ¶¯æ”¶å…¥æ¸›å°‘ ${fmt(p.monthlyUpkeep)}`);
}

// æœˆçµç®—
function settleMonth(skipWarnings=false){
  // è¨ˆç®—æœ¬æœˆæ·¨æ”¶å…¥
  const upkeep = Game.projects.reduce((a,p)=>a+p.monthlyUpkeep,0);
  const netIncome = Game.baseIncome - upkeep;
  // æ”¶å…¥
  Game.money += netIncome;
  // æ›´æ–°æ”¶å…¥é¡¯ç¤ºï¼Œè®“å®ƒé¡¯ç¤ºæ·¨æ”¶å…¥
  $('#income').textContent = fmt(netIncome);
  // é•·æœŸæ•ˆæœç–ŠåŠ 
  Game.projects.forEach(p=>{
    for(const [k,v] of Object.entries(p.effects)){
      if(k==='trust'){ Game.trust = clamp(Game.trust + v*0.2,0,100); }
      else { Game.metrics[k] = clamp(Game.metrics[k] + v*0.5, 0, 100); }
    }
  });
    // ç¶­è­·å€¼æ¯æœˆæ‰£æ¸›ï¼Œæ­£å¸¸çµç®— â†’ æ‰£é‹è¡Œ 1
  Game.metrics.maint = Math.max(0, Game.metrics.maint - 1);
  // é‹è¡Œä¸è¶³æ‡²ç½°
  if(Game.metrics.maint < 3){
    Game.trust = Math.max(0, Game.trust - 0.1);
    Game.metrics.edu = Math.max(0, Game.metrics.edu - 0.1);
    Game.metrics.health = Math.max(0, Game.metrics.health - 0.1);
  }
  // ç¾é‡‘ä¸è¶³è­¦ç¤º
  if(Game.money < 0 && !skipWarnings){
    alert('æ³¨æ„ï¼šç¾é‡‘æµç‚ºè² ï¼è«‹å¢åŠ æ”¶å…¥æˆ–æ¸›å°‘æ–°å»ºå°ˆæ¡ˆã€‚');
  }
  // æ™‚é–“éé€²
  Game.month++; if(Game.month>12){ Game.month=1; Game.year++; }
  renderState(); renderProjects(); drawEvents();
  toast('å·²çµç®—æœ¬æœˆï¼šæ”¶å…¥èˆ‡é‹è¡Œå·²é«”ç¾åœ¨æŒ‡æ¨™');
  saveAuto();
}
    function skipToSettle(){
      let roll = Math.floor(Math.random() * 100) + 1; // 1~100
      let finalIncome;

      if(roll <= 5){ // 5%æ©Ÿç‡
        Game.baseIncome += 9999;
        toast('âœ¨ æ„Ÿæ©ï¼ä½ çš„è·æ¶¯æœˆæ”¶å…¥æ°¸ä¹…å¢åŠ  +$9,999 âœ¨');
        finalIncome = 0; // ç•¶æœˆä¸é ˜éŒ¢
      } else { // 95%æ©Ÿç‡ï¼Œéš¨æ©Ÿç²å¾—ä¸€éƒ¨åˆ†æ”¶å…¥
        const percentage = Math.floor(Math.random() * 30) + 1; // 1%~30%
        finalIncome = Math.floor(Game.baseIncome * (percentage / 100));
        toast(`â¡ï¸ ä½ é¸æ“‡ç¦±å‘Šï¼Œæœ¬æœˆæ”¶å…¥ç‚º ${fmt(finalIncome)} ï¼ˆéš¨æ©Ÿçµæœï¼š${percentage}%ï¼‰`);
      }

      Game.money += finalIncome;

      // ä¸æ‰£é‹è¡Œã€ä¸ç®— upkeepï¼Œåªæ¨é€²æ™‚é–“
      Game.month++;
      if(Game.month > 12){
        Game.month = 1;
        Game.year++;
      }

      renderState();
      renderProjects();
      drawEvents();
      saveAuto();
    }

    // å„²å­˜ / è¼‰å…¥
    function save(name='autosave'){
      localStorage.setItem('hometown_saver_'+name, JSON.stringify(Game));
      toast('å·²å„²å­˜é€²åº¦');
    }
    function load(name='autosave'){
      const raw = localStorage.getItem('hometown_saver_'+name);
      if(!raw){ toast('æ‰¾ä¸åˆ°å­˜æª”'); return; }
      const data = JSON.parse(raw);
      Object.assign(Game, data);
      renderState(); renderProjects(); drawEvents();
      toast('è¼‰å…¥æˆåŠŸ');
    }
    const saveAuto = ()=> save('autosave');

    // å…¶ä»–è¼”åŠ©
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function pick(arr, n){
      const pool = [...arr]; const out=[]; while(out.length<n && pool.length){
        const i = Math.floor(Math.random()*pool.length); out.push(pool.splice(i,1)[0]);
      } return out;
    }
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg; t.className='pill'; t.style.position='fixed'; t.style.right='18px'; t.style.bottom='18px'; t.style.zIndex=50; t.style.background='#0b1222ee'; t.style.border='1px solid #1f2a44';
      document.body.appendChild(t); setTimeout(()=>t.remove(), 2200);
    }

    // äº‹ä»¶ç¶å®š
    $('#saveBtn').onclick = ()=> save('slot1');
    $('#loadBtn').onclick = ()=> load('slot1');
    $('#resetBtn').onclick = ()=>{ if(confirm('ç¢ºå®šè¦é–‹æ–°å±€å—ï¼Ÿç›®å‰é€²åº¦å°‡æ¸…é™¤ã€‚')){ localStorage.removeItem('hometown_saver_slot1'); localStorage.removeItem('hometown_saver_autosave'); location.reload(); } };
    $('#renameBtn').onclick = ()=>{
      const name = prompt('è«‹è¼¸å…¥ä½ çš„å®¶é„‰åç¨±ï¼ˆä¾‹å¦‚ï¼šç­å·´åˆ©ã€æ¸…æ°´æ‘â€¦ï¼‰', Game.villageName);
      if(name){ Game.villageName = name.trim().slice(0,20); renderState(); saveAuto(); }
    };
    
    // å»¶é²ç¸®å°è…³éƒ¨æç¤º
    const footer = $('#fixed-footer');
    let shrinkTimeout;

    function resetShrinkTimer() {
        clearTimeout(shrinkTimeout);
        footer.classList.remove('shrink');
        shrinkTimeout = setTimeout(() => {
            footer.classList.add('shrink');
        }, 5000); // 5ç§’å¾Œè‡ªå‹•ç¸®å°
    }
    
    // é»æ“Šã€Œè¡Œå‹•ã€æˆ–ã€Œç¦±å‘Šã€æ™‚ï¼ŒåŸ·è¡Œå°æ‡‰å‡½æ•¸ä¸¦é‡ç½®è¨ˆæ™‚å™¨
    $('#nextBtn').onclick = () => {
      settleMonth();
      resetShrinkTimer();
    };
    
    $('#skipBtn').onclick = () => {
      skipToSettle();
      resetShrinkTimer();
    };

    // é»æ“Šç¸®å°å¾Œçš„æŒ‰éˆ•ï¼Œå±•é–‹æç¤º
    footer.onclick = () => {
        if (footer.classList.contains('shrink')) {
            resetShrinkTimer();
        }
    };

    // åˆå§‹åŒ–
    (function init(){
      renderState(); renderProjects(); drawEvents();
      resetShrinkTimer();
      // åˆå§‹æç¤º
      setTimeout(()=>toast('æç¤ºï¼šç¦±å‘Šå¾ˆé‡è¦ï¼Œä½ è¦å®‰éœä½ çš„å¿ƒï¼Œå‡¡äº‹æ„Ÿæ©æœƒä½¿ä½ å¢å¼·å¿ƒç†å¥åº·ï¼Œå¦‚æå‡å¹¸ç¦æ„Ÿã€æ¸›è¼•ç„¦æ…®èˆ‡æŠ‘é¬±'), 600);
    })();
  </script>
</body>
</html>
